<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EDRP åˆ·é¡Œå·¥å…·</title>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial;
      background: #0b1020;
      color: #eaf0ff;
    }
    .wrap {
      max-width: 920px;
      margin: 28px auto;
      padding: 0 16px;
    }
    h1 { margin: 0 0 14px; }

    .card {
      background: #121a33;
      border-radius: 14px;
      padding: 16px;
      border: 1px solid rgba(255,255,255,.08);
    }

    .meta {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 8px;
      font-size: 14px;
      color: rgba(234,240,255,.75);
    }

    .qtitle {
      font-size: 18px;
      line-height: 1.55;
      margin: 6px 0 12px;
      white-space: pre-wrap;
    }

    .choice {
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 10px;
      padding: 10px 12px;
      margin-top: 10px;
      cursor: pointer;
      background: rgba(255,255,255,.03);
      user-select: none;
      line-height: 1.5;
    }
    .choice:hover { border-color: rgba(159,176,255,.6); }
    .choice.correct {
      border-color: rgba(52,211,153,.9);
      background: rgba(52,211,153,.12);
    }
    .choice.wrong {
      border-color: rgba(251,113,133,.9);
      background: rgba(251,113,133,.12);
    }
    .choice.disabled {
      cursor: default;
      opacity: .95;
    }

    button {
      margin-top: 14px;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.12);
      cursor: pointer;
      background: rgba(255,255,255,.06);
      color: #eaf0ff;
      font-size: 14px;
    }
    button:hover { filter: brightness(1.1); }

    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .feedback {
      margin-top: 14px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,.10);
      display: none;
    }

    .tag {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      margin-right: 8px;
    }
    .ok { background: rgba(52,211,153,.14); color: rgb(52,211,153); }
    .bad { background: rgba(251,113,133,.14); color: rgb(251,113,133); }

    .explain {
      margin-top: 10px;
      white-space: pre-wrap;
      line-height: 1.55;
      color: rgba(234,240,255,.92);
    }

    details { margin-top: 18px; }
    summary { cursor: pointer; color: rgba(159,176,255,.9); }

    textarea {
      width: 100%;
      height: 160px;
      margin-top: 8px;
      background: rgba(255,255,255,.04);
      color: #eaf0ff;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 10px;
      padding: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      box-sizing: border-box;
    }
  </style>
</head>

<body>
<div class="wrap">
  <h1>EDRP åˆ·é¡Œå·¥å…·</h1>

  <div class="card">
    <div class="meta">
      <span id="pos"></span>
      <span id="qid"></span>
      <span id="chapter"></span>
      <span id="mode"></span>
    </div>

    <div class="qtitle" id="question"></div>
    <div id="choices"></div>

    <div class="feedback" id="feedback"></div>

    <div class="toolbar">
      <button onclick="next()">ä¸‹ä¸€é¡Œ</button>
      <button onclick="toggleWrongMode()">åªç·´ç¿’æœ¬æ¬¡éŒ¯é¡Œ</button>
      <button onclick="resetSession()">é‡ç½®æœ¬æ¬¡éŒ¯é¡Œ</button>
    </div>
  </div>

  <details>
    <summary>åŒ¯å…¥ / åŒ¯å‡ºé¡Œåº«ï¼ˆJSONï¼‰</summary>

    <p>æ–¹æ³•ä¸€ï¼šè²¼ä¸Š JSON</p>
    <textarea id="bankArea"></textarea>
    <button onclick="importFromText()">è²¼ä¸ŠåŒ¯å…¥ï¼ˆå–ä»£ï¼‰</button>

    <hr>

    <p>æ–¹æ³•äºŒï¼šå¾æª”æ¡ˆåŒ¯å…¥ï¼ˆ.jsonï¼‰</p>
    <input type="file" id="fileInput" accept=".json">
    <br>
    <button onclick="importFromFile()">æª”æ¡ˆåŒ¯å…¥ï¼ˆå–ä»£ï¼‰</button>

    <hr>

    <button onclick="exportBank()">åŒ¯å‡ºç›®å‰é¡Œåº«</button>
  </details>
</div>

<script>
/* ========= å·¥å…· ========= */
function toLetter(i) { return String.fromCharCode(65 + i); }
function esc(s) {
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ========= ç‹€æ…‹ ========= */
let bank = [
  {
    id: "DEMO",
    chapter: "Demo",
    q: "é€™æ˜¯ä¸€é¡Œç¤ºç¯„é¡Œï¼šåªè¦é¸éŒ¯ä¸€æ¬¡ï¼Œå°±æœƒé€²å…¥æœ¬æ¬¡éŒ¯é¡Œæ¸…å–®ã€‚",
    choices: ["äº†è§£", "æ²’å•é¡Œ", "å¯ä»¥é–‹å§‹äº†", "GO"],
    answer: 0,
    explain: "é€™é¡Œåªæ˜¯ç¤ºç¯„ç”¨ï¼ŒåŒ¯å…¥ä½ è‡ªå·±çš„é¡Œåº«å³å¯ã€‚"
  }
];

let order = [];
let idx = 0;
let locked = false;
let wrongOnly = false;

// â­ æœ¬æ¬¡ä½œç­”éŒ¯é¡Œï¼ˆsession-basedï¼‰
let sessionWrongs = {};

/* ========= æ ¸å¿ƒ ========= */
function rebuildOrder() {
  order = bank
    .map((_, i) => i)
    .filter(i => !wrongOnly || sessionWrongs[bank[i].id]);

  idx = 0;
}

function render() {
  if (order.length === 0) {
    document.getElementById("question").textContent =
      wrongOnly ? "ç›®å‰å°šæœªæœ‰æœ¬æ¬¡éŒ¯é¡Œ ğŸ‰" : "é¡Œåº«æ˜¯ç©ºçš„";
    document.getElementById("choices").innerHTML = "";
    document.getElementById("pos").textContent = "";
    document.getElementById("qid").textContent = "";
    document.getElementById("chapter").textContent = "";
    document.getElementById("mode").textContent = wrongOnly ? "Â· æœ¬æ¬¡éŒ¯é¡Œæ¨¡å¼" : "";
    document.getElementById("feedback").style.display = "none";
    return;
  }

  const q = bank[order[idx]];
  locked = false;

  document.getElementById("pos").textContent = `é¡Œç›® ${idx + 1}/${order.length}`;
  document.getElementById("qid").textContent = q.id ? `Â· ${q.id}` : "";
  document.getElementById("chapter").textContent = q.chapter ? `Â· ${q.chapter}` : "";
  document.getElementById("mode").textContent = wrongOnly ? "Â· æœ¬æ¬¡éŒ¯é¡Œæ¨¡å¼" : "";

  document.getElementById("question").textContent = q.q;

  const c = document.getElementById("choices");
  c.innerHTML = "";
  q.choices.forEach((t, i) => {
    const d = document.createElement("div");
    d.className = "choice";
    d.innerHTML = `<b>${toLetter(i)}.</b> ${esc(t)}`;
    d.onclick = () => choose(i);
    c.appendChild(d);
  });

  const fb = document.getElementById("feedback");
  fb.style.display = "none";
  fb.innerHTML = "";
}

function choose(i) {
  if (locked) return;
  locked = true;

  const q = bank[order[idx]];
  const nodes = document.querySelectorAll(".choice");

  nodes.forEach((n, k) => {
    n.classList.add("disabled");
    if (k === q.answer) n.classList.add("correct");
    if (k === i && i !== q.answer) n.classList.add("wrong");
  });

  const isCorrect = (i === q.answer);

  // â­ åªè¦éŒ¯ä¸€æ¬¡ï¼Œå°±è¨˜éŒ„ç‚ºæœ¬æ¬¡éŒ¯é¡Œ
  if (!isCorrect) {
    sessionWrongs[q.id] = true;
  }

  const fb = document.getElementById("feedback");
  fb.style.display = "block";
  fb.innerHTML = `
    <div>
      <span class="tag ${isCorrect ? "ok" : "bad"}">
        ${isCorrect ? "ç­”å°" : "ç­”éŒ¯"}
      </span>
      <span style="font-size:13px;color:rgba(234,240,255,.7)">
        ä½ çš„ç­”æ¡ˆï¼š${toLetter(i)} Â· æ­£è§£ï¼š${toLetter(q.answer)}
      </span>
    </div>
    <div class="explain">${esc(q.explain || "ï¼ˆæ²’æœ‰è§£æï¼‰")}</div>
  `;
}

function next() {
  idx = (idx + 1) % order.length;
  render();
}

function toggleWrongMode() {
  wrongOnly = !wrongOnly;
  rebuildOrder();
  render();
}

function resetSession() {
  if (!confirm("è¦æ¸…é™¤æœ¬æ¬¡æ‰€æœ‰éŒ¯é¡Œç´€éŒ„å—ï¼Ÿ")) return;
  sessionWrongs = {};
  wrongOnly = false;
  rebuildOrder();
  render();
}

/* ========= åŒ¯å…¥ / åŒ¯å‡º ========= */
function validateBank(parsed) {
  if (!Array.isArray(parsed)) throw new Error("é¡Œåº«å¿…é ˆæ˜¯ JSON é™£åˆ—");
  parsed.forEach((it, n) => {
    if (!it.q || !Array.isArray(it.choices) || typeof it.answer !== "number")
      throw new Error(`ç¬¬ ${n + 1} é¡Œæ ¼å¼éŒ¯èª¤`);
    if (it.answer < 0 || it.answer >= it.choices.length)
      throw new Error(`ç¬¬ ${n + 1} é¡Œ answer è¶…å‡ºç¯„åœ`);
  });
}

function importFromText() {
  try {
    const parsed = JSON.parse(document.getElementById("bankArea").value.trim());
    validateBank(parsed);
    bank = parsed;
    sessionWrongs = {};
    rebuildOrder();
    render();
    alert(`æˆåŠŸåŒ¯å…¥ ${bank.length} é¡Œ`);
  } catch (e) {
    alert("åŒ¯å…¥å¤±æ•—ï¼š" + e.message);
  }
}

function importFromFile() {
  const input = document.getElementById("fileInput");
  if (!input.files[0]) return alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆ");

  const reader = new FileReader();
  reader.onload = e => {
    try {
      const parsed = JSON.parse(e.target.result);
      validateBank(parsed);
      bank = parsed;
      sessionWrongs = {};
      rebuildOrder();
      render();
      alert(`æˆåŠŸåŒ¯å…¥ ${bank.length} é¡Œ`);
    } catch (err) {
      alert("åŒ¯å…¥å¤±æ•—ï¼š" + err.message);
    }
  };
  reader.readAsText(input.files[0], "utf-8");
}

function exportBank() {
  document.getElementById("bankArea").value = JSON.stringify(bank, null, 2);
}

/* ========= åˆå§‹åŒ– ========= */
rebuildOrder();
render();
</script>
</body>
</html>
